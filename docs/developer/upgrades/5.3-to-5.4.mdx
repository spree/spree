---
title: Upgrading to Spree 5.4
description: This guide covers upgrading a Spree 5.3 application to Spree 5.4.
---

<Info>
  Before proceeding to upgrade, please ensure you're at [Spree 5.3](/developer/upgrades/5.2-to-5.3)
</Info>

## Upgrade steps

### Update gems

  ```bash
  bundle update
  ```

### Fetch and run missing migrations

  ```bash
  bin/rake spree:install:migrations && bin/rails db:migrate
  ```

### Backfill Image Thumbnail IDs

Spree 5.4 adds a `thumbnail` association to both `Product` and `Variant` models. This greatly speeds up rendering Product lists everywhere (API, Admin Dashboard and `spree_storefront`), as previously we've had to load all images for each product.

This can be done by running the following command:

  ```bash
  bin/rails spree:images:backfill_thumbnails
  ```

As above, this process can take a while depending on the size of your product catalog.

### Prefixed IDs

Spree 5.4 by default uses prefixed IDs for resources (eg. `prod_6VsgxZbenF`) instead of just IDs from the database. These IDs are now used in Admin Dashboard, API v3, Events system and Webhooks.

#### Event Subscribers

If you previously added Subscribers for Events, eg. `order.completed` with code such as:

```ruby
module MyApp
  class OrderAuditSubscriber < Spree::Subscriber
    subscribes_to 'order.complete'

    on 'order.complete', :log_order_completed

    private

    def find_order(event)
      Spree::Order.find(event.payload[:id])
    end
  end
end
```

You will need to update your code to use the new prefixed IDs, from:

```ruby
Spree::Order.find(event.payload[:id])
```

to:

```ruby
Spree::Order.find_by_prefix_id!(event.payload[:id])
```

You can also use `find_by_prefix_id` without the bang (`!`) to gracefully handle cases where the record might not exist.

#### Adding Prefixed IDs support to your custom models

All models inheriting from `Spree::Base` (or `Spree.base_class`) can support Prefixed IDs by adding the following code to your model:

```ruby
class MyModel < Spree::Base
  has_prefix_id :mm
  
  # ...
end
```

Prefix length isn't limited by default, but we recommend to keep it short.

### (Optional) Install API v2

Spree 5.4 ships with API v3, which marks deprecation of API v2. API v2 is still available but you need to install it separately. If you currently use API v2, you can do this by running the following command:

  ```bash
  bundle add spree_legacy_api_v2
  ```
  
If you have tests for API v2 endpoints in your application, you will need to include some files in your `rails_helper.rb`:

  ```ruby
  require 'jsonapi/rspec'
  require 'spree_legacy_api_v2/testing_support/v2/base'
  require 'spree_legacy_api_v2/testing_support/factories'
  require 'spree_legacy_api_v2/testing_support/v2/current_order'
  require 'spree_legacy_api_v2/testing_support/v2/platform_contexts'
  require 'spree_legacy_api_v2/testing_support/v2/serializers_params'
  
  RSpec.configure do |config|
    config.include JSONAPI::RSpec, type: :request # required for API v2 request specs
  end
  ```

Also, add `jsonapi-rspec` gem to your `Gemfile`:

  ```ruby
  gem 'jsonapi-rspec', group: :test
  ```
  
And run `bundle install`
