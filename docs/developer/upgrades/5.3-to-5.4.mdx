---
title: Upgrading to Spree 5.4
description: This guide covers upgrading a Spree 5.3 application to Spree 5.4.
---

<Info>
  Before proceeding to upgrade, please ensure you're at [Spree 5.3](/developer/upgrades/5.2-to-5.3)
</Info>

## Upgrade steps

### Remove `spree_sample` gem from your Gemfile

Samples are now included in the `spree` gem. If you've added previously `spree_sample` to your Gemfile, remove it by running:

  ```bash
  bundle remove spree_sample
  ```

### Update gems

  ```bash
  bundle update
  ```

### Fetch and run missing migrations

  ```bash
  bin/rake spree:install:migrations && bin/rails db:migrate
  ```

### Backfill Image Thumbnail IDs

Spree 5.4 adds a `thumbnail` association to both `Product` and `Variant` models. This greatly speeds up rendering Product lists everywhere (API, Admin Dashboard and `spree_storefront`), as previously we've had to load all images for each product.

This can be done by running the following command:

  ```bash
  bin/rails spree:images:backfill_thumbnails
  ```

As above, this process can take a while depending on the size of your product catalog.

### Prefixed IDs

Spree 5.4 by default uses prefixed IDs for resources (eg. `prod_6VsgxZbenF`) instead of just IDs from the database. These IDs are now used in Admin Dashboard, API v3, Events system and Webhooks.

#### Event Subscribers

If you previously added Subscribers for Events, eg. `order.completed` with code such as:

```ruby
module MyApp
  class OrderAuditSubscriber < Spree::Subscriber
    subscribes_to 'order.complete'

    on 'order.complete', :log_order_completed

    private

    def find_order(event)
      Spree::Order.find(event.payload[:id])
    end
  end
end
```

You will need to update your code to use the new prefixed IDs, from:

```ruby
Spree::Order.find(event.payload[:id])
```

to:

```ruby
Spree::Order.find_by_prefix_id!(event.payload[:id])
```

You can also use `find_by_prefix_id` without the bang (`!`) to gracefully handle cases where the record might not exist.

#### Adding Prefixed IDs support to your custom models

All models inheriting from `Spree::Base` (or `Spree.base_class`) can support Prefixed IDs by adding the following code to your model:

```ruby
class MyModel < Spree::Base
  has_prefix_id :mm
  
  # ...
end
```

Prefix length isn't limited by default, but we recommend to keep it short.

### Migrate Checkout Zones to Markets

Spree 5.4 introduces [Markets](/developer/core-concepts/markets) as the primary way to manage which countries are available for checkout, along with their currencies and locales. The legacy `checkout_zone` field on the Store model is now deprecated and will be removed in Spree 5.5.

New stores automatically get a default market created from their `default_country` — no manual setup needed. For existing stores that used `checkout_zone`, run the migration rake task:

  ```bash
  bin/rake spree:markets:migrate_checkout_zones
  ```

This will:
1. Read the `checkout_zone` countries from each store
2. Create a default Market with those countries, currency, and locale
3. Clear the `checkout_zone_id` column

<Warning>
  You will need to run this rake task locally and on your production environment. After running, verify your markets are set up correctly in the Admin Dashboard under **Settings → Markets**.
</Warning>

#### Deprecated Store methods

The following Store methods now emit deprecation warnings and will be removed in Spree 5.5:

| Deprecated method | Replacement |
|---|---|
| `store.checkout_zone` | Use [Markets](/developer/core-concepts/markets) to manage countries |
| `store.checkout_zone=` | Use [Markets](/developer/core-concepts/markets) to manage countries |

The `store.default_country` reader now returns the first country (by name) from the store's default market. The `store.default_country_iso=` setter still works and is used to set the country when creating a store — a default market is automatically created from it.

#### Code that references `checkout_zone` for tax

If your application used `store.checkout_zone` as a tax zone fallback, update it to use `Spree::Zone.default_tax` instead:

```ruby
# Before
zone = current_store.checkout_zone

# After
zone = Spree::Zone.default_tax
```

### (Optional) Install API v2

Spree 5.4 ships with API v3, which marks deprecation of API v2. API v2 is still available but you need to install it separately. If you currently use API v2, you can do this by running the following command:

  ```bash
  bundle add spree_legacy_api_v2
  ```
  
If you have tests for API v2 endpoints in your application, you will need to include some files in your `rails_helper.rb`:

  ```ruby
  require 'jsonapi/rspec'
  require 'spree_legacy_api_v2/testing_support/v2/base'
  require 'spree_legacy_api_v2/testing_support/factories'
  require 'spree_legacy_api_v2/testing_support/v2/current_order'
  require 'spree_legacy_api_v2/testing_support/v2/platform_contexts'
  require 'spree_legacy_api_v2/testing_support/v2/serializers_params'
  
  RSpec.configure do |config|
    config.include JSONAPI::RSpec, type: :request # required for API v2 request specs
  end
  ```

Also, add `jsonapi-rspec` gem to your `Gemfile`:

  ```ruby
  gem 'jsonapi-rspec', group: :test
  ```
  
And run `bundle install`

### (Optional) Install Spree Multi Store

Multi-store features like multiple store management & custom domains were moved to a seperate gem `spree_multi_store`.

If you rely on these features please run:

  ```bash
  bundle add spree_multi_store
  ```
