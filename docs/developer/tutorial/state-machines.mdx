---
title: State Machines
description: Learn how to use state machines to manage the status of the Brands feature
hidden: true
---

Let's say we want to manage which brands show on Storefront. We also want to attach more business logic to this, eg clear store cache when the brand is published.

## Step 1: Add `status` column to the database table

```bash
bin/rails g migration AddStatusToSpreeBrands status:string:index
```

This will create a new migration file at `db/migrate/<YYYYMMDDHHMMSS>_add_status_to_spree_brands.rb`.

Now run the migration:

```bash
bin/rails db:migrate
```

### Add State Machine for Brand Status

This will add the `status` column to the `spree_brands` table and add an index on the `status` column.

## Step 2: Add State Machine for Brand Status

Let's implement some business logic in the model:

```ruby app/models/spree/brand.rb
module Spree
  class Brand < Spree::Base
    # ... other code ...

    # [!code ++:13]
    # Scopes
    scope :published, -> { where(status: 'published') }

    # State machine for brand status
    state_machine :status, initial: :draft do 
      event :publish do
        transition draft: :published
      end
      after_transition to: :published do |brand|
        Spree::Store.touch_all # clear store cache
      end
    end
  end
end
```

Now every `Spree::Brand` instance will have a `status` attribute with the value of `draft` by default. When the brand is published, the `status` will be set to `published` and the `published_at` timestamp will be set to the current time.

We've also added `published` scope to the model to filter the brands by status, eg.

```ruby
Spree::Brand.published.count
# => 1

Spree::Brand.published.first
# => #<Spree::Brand:0x0000000100000000 id: 1, name: "Nike", slug: "nike", status: "published", published_at: 2021-01-01 00:00:00>
```