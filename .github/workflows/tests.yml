name: Tests

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - 'packages/**'
      - '**/*.md'
  pull_request:
    paths-ignore:
      - 'docs/**'
      - 'packages/**'
      - '**/*.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-postgres:
    name: "Build (PostgreSQL)"
    runs-on: ubuntu-latest
    env:
      DB: postgres
      RAILS_VERSION: "~> 8.1.0"
      BUNDLE_JOBS: 4
      BUNDLE_RETRY: 3
    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '4.0'

      - name: Cache Ruby gems
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: gems-${{ runner.os }}-ruby4.0-postgres-${{ hashFiles('backend/Gemfile.lock') }}
          restore-keys: |
            gems-${{ runner.os }}-ruby4.0-postgres-

      - name: Install root dependencies
        working-directory: backend/engines
        run: |
          bundle config set --local path ${{ github.workspace }}/vendor/bundle
          bundle install

      - name: Install all project dependencies
        run: |
          for project in core api admin emails multi_store; do
            echo "--- Installing gems for $project ---"
            cd backend/engines/$project
            bundle config set --local path ${{ github.workspace }}/vendor/bundle
            bundle install
            cd ${{ github.workspace }}
          done

  build-mysql:
    name: "Build (MySQL)"
    runs-on: ubuntu-latest
    env:
      DB: mysql
      RAILS_VERSION: "7.2.0"
      BUNDLE_JOBS: 4
      BUNDLE_RETRY: 3
    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '4.0'

      - name: Cache Ruby gems
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: gems-${{ runner.os }}-ruby4.0-mysql-${{ hashFiles('backend/Gemfile.lock') }}
          restore-keys: |
            gems-${{ runner.os }}-ruby4.0-mysql-

      - name: Install root dependencies
        working-directory: backend/engines
        run: |
          bundle config set --local path ${{ github.workspace }}/vendor/bundle
          bundle install

      - name: Install all project dependencies
        run: |
          for project in core api admin emails multi_store; do
            echo "--- Installing gems for $project ---"
            cd backend/engines/$project
            bundle config set --local path ${{ github.workspace }}/vendor/bundle
            bundle install
            cd ${{ github.workspace }}
          done

  test-postgres:
    name: "PostgreSQL - ${{ matrix.project }} (${{ matrix.shard }}/${{ matrix.total_shards }})"
    needs: build-postgres
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # core: 6 shards
          - { project: core, shard: 1, total_shards: 6 }
          - { project: core, shard: 2, total_shards: 6 }
          - { project: core, shard: 3, total_shards: 6 }
          - { project: core, shard: 4, total_shards: 6 }
          - { project: core, shard: 5, total_shards: 6 }
          - { project: core, shard: 6, total_shards: 6 }
          # api: 2 shards
          - { project: api, shard: 1, total_shards: 2 }
          - { project: api, shard: 2, total_shards: 2 }
          # admin: 2 shards
          - { project: admin, shard: 1, total_shards: 2 }
          - { project: admin, shard: 2, total_shards: 2 }
          # emails: 1 shard
          - { project: emails, shard: 1, total_shards: 1 }
          # multi_store: 1 shard
          - { project: multi_store, shard: 1, total_shards: 1 }
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DB: postgres
      DB_HOST: localhost
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      RAILS_VERSION: "~> 8.1.0"
      CI_ARTIFACTS: /tmp/test-artifacts
      BUNDLE_JOBS: 4
      BUNDLE_RETRY: 3
      COVERAGE: true
      COVERAGE_DIR: ${{ github.workspace }}/coverage
      CI_SHARD: ${{ matrix.shard }}
    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '4.0'

      - name: Restore gem cache
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: gems-${{ runner.os }}-ruby4.0-postgres-${{ hashFiles('backend/Gemfile.lock') }}
          restore-keys: |
            gems-${{ runner.os }}-ruby4.0-postgres-

      - name: Install libvips
        run: sudo apt-get update && sudo apt-get install -y libvips-dev

      - name: Install dependencies
        run: |
          cd backend/engines
          bundle config set --local path ${{ github.workspace }}/vendor/bundle
          bundle install
          cd ${{ matrix.project }}
          bundle config set --local path ${{ github.workspace }}/vendor/bundle
          bundle install

      - name: Setup test app
        working-directory: backend/engines/${{ matrix.project }}
        run: |
          if [[ "${{ matrix.project }}" == "core" || "${{ matrix.project }}" == "api" ]]; then
            bundle exec --gemfile=${{ github.workspace }}/backend/engines/Gemfile rake test_app
          else
            bundle exec rake test_app
          fi

      - name: Select shard specs
        id: specs
        working-directory: backend/engines/${{ matrix.project }}
        run: |
          all_specs=($(find spec -name '*_spec.rb' | sort))
          total=${#all_specs[@]}
          shard_specs=()
          shard_index=$(( ${{ matrix.shard }} - 1 ))
          for ((i=0; i<total; i++)); do
            if (( i % ${{ matrix.total_shards }} == shard_index )); then
              shard_specs+=("${all_specs[$i]}")
            fi
          done
          echo "Found ${#shard_specs[@]} specs for shard ${{ matrix.shard }}/${{ matrix.total_shards }} (out of $total total)"
          echo "files=${shard_specs[*]}" >> "$GITHUB_OUTPUT"

      - name: Run tests
        working-directory: backend/engines/${{ matrix.project }}
        run: |
          mkdir -p ${{ github.workspace }}/tmp/test-results/rspec
          bundle exec rspec \
            --order random \
            --format progress \
            --profile 10 \
            -r rspec_junit_formatter \
            --format RspecJunitFormatter \
            -o ${{ github.workspace }}/tmp/test-results/rspec/${{ matrix.project }}-${{ matrix.shard }}.xml \
            ${{ steps.specs.outputs.files }}

      - name: List coverage files
        if: always()
        run: |
          echo "--- Coverage directory contents ---"
          find ${{ github.workspace }}/coverage -type f 2>/dev/null || echo "No coverage directory found"

      - name: Upload coverage to Codecov
        if: always() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ${{ github.workspace }}/coverage
          flags: ${{ matrix.project }}
          name: ${{ matrix.project }}-shard-${{ matrix.shard }}
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-postgres-${{ matrix.project }}-${{ matrix.shard }}
          path: tmp/test-results/
          if-no-files-found: ignore

      - name: Upload failed test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-screenshots-postgres-${{ matrix.project }}-${{ matrix.shard }}
          path: /tmp/test-artifacts/
          if-no-files-found: ignore

  test-mysql:
    name: "MySQL - ${{ matrix.project }} (${{ matrix.shard }}/${{ matrix.total_shards }})"
    needs: build-mysql
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # core: 6 shards
          - { project: core, shard: 1, total_shards: 6 }
          - { project: core, shard: 2, total_shards: 6 }
          - { project: core, shard: 3, total_shards: 6 }
          - { project: core, shard: 4, total_shards: 6 }
          - { project: core, shard: 5, total_shards: 6 }
          - { project: core, shard: 6, total_shards: 6 }
          # api: 2 shards
          - { project: api, shard: 1, total_shards: 2 }
          - { project: api, shard: 2, total_shards: 2 }
          # admin: 2 shards
          - { project: admin, shard: 1, total_shards: 2 }
          - { project: admin, shard: 2, total_shards: 2 }
          # emails: 1 shard
          - { project: emails, shard: 1, total_shards: 1 }
          # multi_store: 1 shard
          - { project: multi_store, shard: 1, total_shards: 1 }
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DB: mysql
      DB_HOST: 127.0.0.1
      DB_USERNAME: root
      DB_PASSWORD: password
      RAILS_VERSION: "7.2.0"
      CI_ARTIFACTS: /tmp/test-artifacts
      BUNDLE_JOBS: 4
      BUNDLE_RETRY: 3
    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '4.0'

      - name: Restore gem cache
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: gems-${{ runner.os }}-ruby4.0-mysql-${{ hashFiles('backend/Gemfile.lock') }}
          restore-keys: |
            gems-${{ runner.os }}-ruby4.0-mysql-

      - name: Install libvips
        run: sudo apt-get update && sudo apt-get install -y libvips-dev

      - name: Install dependencies
        run: |
          cd backend/engines
          bundle config set --local path ${{ github.workspace }}/vendor/bundle
          bundle install
          cd ${{ matrix.project }}
          bundle config set --local path ${{ github.workspace }}/vendor/bundle
          bundle install

      - name: Setup test app
        working-directory: backend/engines/${{ matrix.project }}
        run: |
          if [[ "${{ matrix.project }}" == "core" || "${{ matrix.project }}" == "api" ]]; then
            bundle exec --gemfile=${{ github.workspace }}/backend/engines/Gemfile rake test_app
          else
            bundle exec rake test_app
          fi

      - name: Select shard specs
        id: specs
        working-directory: backend/engines/${{ matrix.project }}
        run: |
          all_specs=($(find spec -name '*_spec.rb' | sort))
          total=${#all_specs[@]}
          shard_specs=()
          shard_index=$(( ${{ matrix.shard }} - 1 ))
          for ((i=0; i<total; i++)); do
            if (( i % ${{ matrix.total_shards }} == shard_index )); then
              shard_specs+=("${all_specs[$i]}")
            fi
          done
          echo "Found ${#shard_specs[@]} specs for shard ${{ matrix.shard }}/${{ matrix.total_shards }} (out of $total total)"
          echo "files=${shard_specs[*]}" >> "$GITHUB_OUTPUT"

      - name: Run tests
        working-directory: backend/engines/${{ matrix.project }}
        run: |
          mkdir -p ${{ github.workspace }}/tmp/test-results/rspec
          bundle exec rspec \
            --order random \
            --format progress \
            --profile 10 \
            -r rspec_junit_formatter \
            --format RspecJunitFormatter \
            -o ${{ github.workspace }}/tmp/test-results/rspec/${{ matrix.project }}-${{ matrix.shard }}.xml \
            ${{ steps.specs.outputs.files }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-mysql-${{ matrix.project }}-${{ matrix.shard }}
          path: tmp/test-results/
          if-no-files-found: ignore

      - name: Upload failed test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-screenshots-mysql-${{ matrix.project }}-${{ matrix.shard }}
          path: /tmp/test-artifacts/
          if-no-files-found: ignore

  brakeman:
    name: Brakeman
    needs: build-postgres
    runs-on: ubuntu-latest
    env:
      DB: postgres
      BUNDLE_JOBS: 4
      BUNDLE_RETRY: 3
    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '4.0'

      - name: Restore gem cache
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: gems-${{ runner.os }}-ruby4.0-postgres-${{ hashFiles('backend/Gemfile.lock') }}
          restore-keys: |
            gems-${{ runner.os }}-ruby4.0-postgres-

      - name: Install dependencies
        working-directory: backend/engines
        run: |
          bundle config set --local path ${{ github.workspace }}/vendor/bundle
          bundle install

      - name: Run Brakeman
        working-directory: backend/engines
        run: |
          for project in core api admin; do
            echo "--- Running Brakeman on $project ---"
            bundle exec brakeman --ensure-latest -p $project
          done

      - name: Upload Brakeman reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brakeman-reports
          path: backend/engines/brakeman-*.*
          if-no-files-found: ignore
