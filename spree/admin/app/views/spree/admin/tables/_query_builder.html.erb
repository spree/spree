<%# locals: (table:, table_key:, frame_name:) %>
<% fields_json = query_builder_fields_json(table) %>
<% operators_json = query_builder_operators_json %>
<% current_state = params[:query_state] || '{}' %>
<% filter_count = count_applied_filters(current_state) %>

<div data-controller="dialog" class="h-full">
  <button type="button"
          class="btn btn-light btn-sm h-[2.125rem]"
          data-action="dialog#open">
    <%= icon 'filter' %>
    <span><%= Spree.t('admin.tables.filters') %></span>
    <% if filter_count > 0 %>
      <span class="badge badge-light"><%= filter_count %></span>
    <% end %>
  </button>

  <%= drawer(id: "query-builder-drawer-#{table_key}", controller_name: 'dialog') do %>
    <%= drawer_header(Spree.t('admin.tables.filter_builder'), 'dialog') %>

    <div data-controller="query-builder"
         data-query-builder-fields-value="<%= fields_json %>"
         data-query-builder-operators-value="<%= operators_json %>"
         class="grow flex flex-col justify-between">

      <%= form_with url: url_for, method: :get, html: { class: 'grow flex flex-col justify-between' }, data: { turbo_frame: frame_name, turbo_action: 'advance', query_builder_target: 'form', action: 'submit->query-builder#submitForm' } do |f| %>
        <div class="drawer-body">
          <div class="mb-4 flex items-center gap-2 flex-wrap">
            <span class="text-sm text-gray-600">
              <%= Spree.t('admin.tables.match') %>
            </span>
            <button type="button"
                    class="btn btn-sm btn-outline-secondary px-2 py-1"
                    data-action="query-builder#toggleCombinator"
                    data-query-builder-target="combinatorButton">
              <span data-query-builder-target="combinatorLabel">AND</span>
            </button>
            <span class="text-sm text-gray-600">
              <%= Spree.t('admin.tables.of_the_following') %>
            </span>
          </div>

          <div data-query-builder-target="filtersContainer" class="space-y-3 mb-4">
            <%# Filter rows will be added here dynamically %>
          </div>

          <div data-query-builder-target="groupsContainer" class="space-y-3 mb-4">
            <%# Nested groups will be added here %>
          </div>

          <div class="flex gap-2">
            <button type="button"
                    class="btn btn-sm btn-light flex items-center gap-1"
                    data-action="query-builder#addFilter">
              <%= icon 'plus', class: 'w-4 h-4' %>
              <%= Spree.t('admin.tables.add_filter') %>
            </button>
            <button type="button"
                    class="btn btn-sm btn-light flex items-center gap-1"
                    data-action="query-builder#addOrGroup">
              <%= icon 'brackets', class: 'w-4 h-4' %>
              <%= Spree.t('admin.tables.add_or_group') %>
            </button>
          </div>

          <input type="hidden"
                 name="query_state"
                 data-query-builder-target="hiddenInput"
                 value="<%= h current_state %>">
        </div>

        <div class="drawer-footer">
          <%= drawer_discard_button('dialog') %>
          <button type="button"
                  class="btn btn-light"
                  data-action="query-builder#clear">
            <%= Spree.t('admin.tables.clear_all') %>
          </button>
          <%= f.submit Spree.t('admin.tables.apply_filters'),
                       class: 'btn btn-primary cursor-pointer' %>
        </div>
      <% end %>

      <%# Filter row template %>
      <template data-query-builder-target="filterTemplate">
        <%= render 'spree/admin/tables/filter_row' %>
      </template>

      <%# Filter group template %>
      <template data-query-builder-target="groupTemplate">
        <%= render 'spree/admin/tables/filter_group' %>
      </template>
    </div>
  <% end %>
</div>
