{"version":3,"sources":["../../src/actions/cart.ts","../../src/config.ts","../../src/cookies.ts"],"sourcesContent":["'use server';\n\nimport { revalidateTag } from 'next/cache';\nimport type { StoreOrder, StoreLineItem } from '@spree/sdk';\nimport { getClient } from '../config';\nimport { getCartToken, setCartToken, clearCartToken, getAccessToken } from '../cookies';\n\n/**\n * Get the current cart. Returns null if no cart exists.\n */\nexport async function getCart(): Promise<(StoreOrder & { token: string }) | null> {\n  const orderToken = await getCartToken();\n  const token = await getAccessToken();\n  if (!orderToken && !token) return null;\n\n  try {\n    return await getClient().cart.get({ orderToken, token });\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Get existing cart or create a new one.\n */\nexport async function getOrCreateCart(): Promise<StoreOrder & { token: string }> {\n  const existing = await getCart();\n  if (existing) return existing;\n\n  const token = await getAccessToken();\n  const cart = await getClient().cart.create(token ? { token } : undefined);\n\n  if (cart.token) {\n    await setCartToken(cart.token);\n  }\n\n  revalidateTag('cart');\n  return cart;\n}\n\n/**\n * Add an item to the cart. Creates a cart if none exists.\n */\nexport async function addItem(\n  variantId: string,\n  quantity: number = 1\n): Promise<StoreLineItem> {\n  const cart = await getOrCreateCart();\n  const orderToken = cart.token;\n  const token = await getAccessToken();\n\n  const lineItem = await getClient().orders.lineItems.create(\n    cart.id,\n    { variant_id: variantId, quantity },\n    { orderToken, token }\n  );\n\n  revalidateTag('cart');\n  return lineItem;\n}\n\n/**\n * Update a line item quantity in the cart.\n */\nexport async function updateItem(\n  lineItemId: string,\n  quantity: number\n): Promise<StoreLineItem> {\n  const orderToken = await getCartToken();\n  const token = await getAccessToken();\n  if (!orderToken && !token) throw new Error('No cart found');\n\n  const cart = await getClient().cart.get({ orderToken, token });\n\n  const lineItem = await getClient().orders.lineItems.update(\n    cart.id,\n    lineItemId,\n    { quantity },\n    { orderToken, token }\n  );\n\n  revalidateTag('cart');\n  return lineItem;\n}\n\n/**\n * Remove a line item from the cart.\n */\nexport async function removeItem(lineItemId: string): Promise<void> {\n  const orderToken = await getCartToken();\n  const token = await getAccessToken();\n  if (!orderToken && !token) throw new Error('No cart found');\n\n  const cart = await getClient().cart.get({ orderToken, token });\n\n  await getClient().orders.lineItems.delete(cart.id, lineItemId, {\n    orderToken,\n    token,\n  });\n\n  revalidateTag('cart');\n}\n\n/**\n * Clear the cart (abandons the current cart).\n */\nexport async function clearCart(): Promise<void> {\n  await clearCartToken();\n  revalidateTag('cart');\n}\n\n/**\n * Associate a guest cart with the currently authenticated user.\n * Call this after login/register when the user has an existing guest cart.\n */\nexport async function associateCart(): Promise<(StoreOrder & { token: string }) | null> {\n  const orderToken = await getCartToken();\n  const token = await getAccessToken();\n  if (!orderToken || !token) return null;\n\n  try {\n    const result = await getClient().cart.associate({ orderToken, token });\n    revalidateTag('cart');\n    return result;\n  } catch {\n    // Cart might already belong to another user â€” clear it\n    await clearCartToken();\n    revalidateTag('cart');\n    return null;\n  }\n}\n","import { createSpreeClient, type SpreeClient } from '@spree/sdk';\nimport type { SpreeNextConfig } from './types';\n\nlet _client: SpreeClient | null = null;\nlet _config: SpreeNextConfig | null = null;\n\n/**\n * Initialize the Spree Next.js integration.\n * Call this once in your app (e.g., in `lib/storefront.ts`).\n * If not called, the client will auto-initialize from SPREE_API_URL and SPREE_API_KEY env vars.\n */\nexport function initSpreeNext(config: SpreeNextConfig): void {\n  _config = config;\n  _client = createSpreeClient({\n    baseUrl: config.baseUrl,\n    apiKey: config.apiKey,\n  });\n}\n\n/**\n * Get the SpreeClient instance. Auto-initializes from env vars if needed.\n * @internal\n */\nexport function getClient(): SpreeClient {\n  if (!_client) {\n    const baseUrl = process.env.SPREE_API_URL;\n    const apiKey = process.env.SPREE_API_KEY;\n    if (baseUrl && apiKey) {\n      initSpreeNext({ baseUrl, apiKey });\n    } else {\n      throw new Error(\n        '@spree/next is not configured. Either call initSpreeNext() or set SPREE_API_URL and SPREE_API_KEY environment variables.'\n      );\n    }\n  }\n  return _client!;\n}\n\n/**\n * Get the current config. Auto-initializes from env vars if needed.\n * @internal\n */\nexport function getConfig(): SpreeNextConfig {\n  if (!_config) {\n    getClient(); // triggers auto-init\n  }\n  return _config!;\n}\n\n/**\n * Reset the client (useful for testing).\n * @internal\n */\nexport function resetClient(): void {\n  _client = null;\n  _config = null;\n}\n","import { cookies } from 'next/headers';\nimport { getConfig } from './config';\n\nconst DEFAULT_CART_COOKIE = '_spree_cart_token';\nconst DEFAULT_ACCESS_TOKEN_COOKIE = '_spree_jwt';\nconst CART_TOKEN_MAX_AGE = 60 * 60 * 24 * 30; // 30 days\nconst ACCESS_TOKEN_MAX_AGE = 60 * 60 * 24 * 7; // 7 days\n\nfunction getCartCookieName(): string {\n  try {\n    return getConfig().cartCookieName ?? DEFAULT_CART_COOKIE;\n  } catch {\n    return DEFAULT_CART_COOKIE;\n  }\n}\n\nfunction getAccessTokenCookieName(): string {\n  try {\n    return getConfig().accessTokenCookieName ?? DEFAULT_ACCESS_TOKEN_COOKIE;\n  } catch {\n    return DEFAULT_ACCESS_TOKEN_COOKIE;\n  }\n}\n\n// --- Cart Token ---\n\nexport async function getCartToken(): Promise<string | undefined> {\n  const cookieStore = await cookies();\n  return cookieStore.get(getCartCookieName())?.value;\n}\n\nexport async function setCartToken(token: string): Promise<void> {\n  const cookieStore = await cookies();\n  cookieStore.set(getCartCookieName(), token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    path: '/',\n    maxAge: CART_TOKEN_MAX_AGE,\n  });\n}\n\nexport async function clearCartToken(): Promise<void> {\n  const cookieStore = await cookies();\n  cookieStore.set(getCartCookieName(), '', {\n    maxAge: -1,\n    path: '/',\n  });\n}\n\n// --- Access Token (JWT) ---\n\nexport async function getAccessToken(): Promise<string | undefined> {\n  const cookieStore = await cookies();\n  return cookieStore.get(getAccessTokenCookieName())?.value;\n}\n\nexport async function setAccessToken(token: string): Promise<void> {\n  const cookieStore = await cookies();\n  cookieStore.set(getAccessTokenCookieName(), token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    path: '/',\n    maxAge: ACCESS_TOKEN_MAX_AGE,\n  });\n}\n\nexport async function clearAccessToken(): Promise<void> {\n  const cookieStore = await cookies();\n  cookieStore.set(getAccessTokenCookieName(), '', {\n    maxAge: -1,\n    path: '/',\n  });\n}\n"],"mappings":"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","names":[]}