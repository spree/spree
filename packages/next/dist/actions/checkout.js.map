{"version":3,"sources":["../../src/actions/checkout.ts","../../src/config.ts","../../src/cookies.ts"],"sourcesContent":["'use server';\n\nimport { revalidateTag } from 'next/cache';\nimport type { StoreOrder, StoreShipment, AddressParams } from '@spree/sdk';\nimport { getClient } from '../config';\nimport { getCartToken, getAccessToken } from '../cookies';\n\nasync function getCheckoutOptions() {\n  const orderToken = await getCartToken();\n  const token = await getAccessToken();\n  return { orderToken, token };\n}\n\n/**\n * Get the current checkout order state.\n */\nexport async function getCheckout(\n  orderId: string\n): Promise<StoreOrder> {\n  const options = await getCheckoutOptions();\n  return getClient().orders.get(orderId, undefined, options);\n}\n\n/**\n * Update shipping and/or billing addresses on the order.\n */\nexport async function updateAddresses(\n  orderId: string,\n  params: {\n    email?: string;\n    ship_address?: AddressParams;\n    bill_address?: AddressParams;\n    ship_address_id?: string;\n    bill_address_id?: string;\n  }\n): Promise<StoreOrder> {\n  const options = await getCheckoutOptions();\n  const result = await getClient().orders.update(orderId, params, options);\n  revalidateTag('checkout');\n  return result;\n}\n\n/**\n * Advance the checkout to the next step.\n */\nexport async function advance(orderId: string): Promise<StoreOrder> {\n  const options = await getCheckoutOptions();\n  const result = await getClient().orders.advance(orderId, options);\n  revalidateTag('checkout');\n  return result;\n}\n\n/**\n * Move the checkout to the next step (alias for advance).\n */\nexport async function next(orderId: string): Promise<StoreOrder> {\n  const options = await getCheckoutOptions();\n  const result = await getClient().orders.next(orderId, options);\n  revalidateTag('checkout');\n  return result;\n}\n\n/**\n * Get shipments for the order (includes available shipping rates).\n */\nexport async function getShipments(\n  orderId: string\n): Promise<{ data: StoreShipment[] }> {\n  const options = await getCheckoutOptions();\n  return getClient().orders.shipments.list(orderId, options);\n}\n\n/**\n * Select a shipping rate for a shipment.\n */\nexport async function selectShippingRate(\n  orderId: string,\n  shipmentId: string,\n  shippingRateId: string\n): Promise<StoreShipment> {\n  const options = await getCheckoutOptions();\n  const result = await getClient().orders.shipments.update(\n    orderId,\n    shipmentId,\n    { selected_shipping_rate_id: shippingRateId },\n    options\n  );\n  revalidateTag('checkout');\n  return result;\n}\n\n/**\n * Apply a coupon code to the order.\n */\nexport async function applyCoupon(\n  orderId: string,\n  code: string\n): Promise<StoreOrder> {\n  const options = await getCheckoutOptions();\n  const result = await getClient().orders.couponCodes.apply(orderId, code, options);\n  revalidateTag('checkout');\n  revalidateTag('cart');\n  return result;\n}\n\n/**\n * Remove a coupon/promotion from the order.\n */\nexport async function removeCoupon(\n  orderId: string,\n  promotionId: string\n): Promise<StoreOrder> {\n  const options = await getCheckoutOptions();\n  const result = await getClient().orders.couponCodes.remove(orderId, promotionId, options);\n  revalidateTag('checkout');\n  revalidateTag('cart');\n  return result;\n}\n\n/**\n * Complete the checkout and place the order.\n */\nexport async function complete(orderId: string): Promise<StoreOrder> {\n  const options = await getCheckoutOptions();\n  const result = await getClient().orders.complete(orderId, options);\n  revalidateTag('checkout');\n  revalidateTag('cart');\n  return result;\n}\n","import { createSpreeClient, type SpreeClient } from '@spree/sdk';\nimport type { SpreeNextConfig } from './types';\n\nlet _client: SpreeClient | null = null;\nlet _config: SpreeNextConfig | null = null;\n\n/**\n * Initialize the Spree Next.js integration.\n * Call this once in your app (e.g., in `lib/storefront.ts`).\n * If not called, the client will auto-initialize from SPREE_API_URL and SPREE_API_KEY env vars.\n */\nexport function initSpreeNext(config: SpreeNextConfig): void {\n  _config = config;\n  _client = createSpreeClient({\n    baseUrl: config.baseUrl,\n    apiKey: config.apiKey,\n  });\n}\n\n/**\n * Get the SpreeClient instance. Auto-initializes from env vars if needed.\n * @internal\n */\nexport function getClient(): SpreeClient {\n  if (!_client) {\n    const baseUrl = process.env.SPREE_API_URL;\n    const apiKey = process.env.SPREE_API_KEY;\n    if (baseUrl && apiKey) {\n      initSpreeNext({ baseUrl, apiKey });\n    } else {\n      throw new Error(\n        '@spree/next is not configured. Either call initSpreeNext() or set SPREE_API_URL and SPREE_API_KEY environment variables.'\n      );\n    }\n  }\n  return _client!;\n}\n\n/**\n * Get the current config. Auto-initializes from env vars if needed.\n * @internal\n */\nexport function getConfig(): SpreeNextConfig {\n  if (!_config) {\n    getClient(); // triggers auto-init\n  }\n  return _config!;\n}\n\n/**\n * Reset the client (useful for testing).\n * @internal\n */\nexport function resetClient(): void {\n  _client = null;\n  _config = null;\n}\n","import { cookies } from 'next/headers';\nimport { getConfig } from './config';\n\nconst DEFAULT_CART_COOKIE = '_spree_cart_token';\nconst DEFAULT_ACCESS_TOKEN_COOKIE = '_spree_jwt';\nconst CART_TOKEN_MAX_AGE = 60 * 60 * 24 * 30; // 30 days\nconst ACCESS_TOKEN_MAX_AGE = 60 * 60 * 24 * 7; // 7 days\n\nfunction getCartCookieName(): string {\n  try {\n    return getConfig().cartCookieName ?? DEFAULT_CART_COOKIE;\n  } catch {\n    return DEFAULT_CART_COOKIE;\n  }\n}\n\nfunction getAccessTokenCookieName(): string {\n  try {\n    return getConfig().accessTokenCookieName ?? DEFAULT_ACCESS_TOKEN_COOKIE;\n  } catch {\n    return DEFAULT_ACCESS_TOKEN_COOKIE;\n  }\n}\n\n// --- Cart Token ---\n\nexport async function getCartToken(): Promise<string | undefined> {\n  const cookieStore = await cookies();\n  return cookieStore.get(getCartCookieName())?.value;\n}\n\nexport async function setCartToken(token: string): Promise<void> {\n  const cookieStore = await cookies();\n  cookieStore.set(getCartCookieName(), token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    path: '/',\n    maxAge: CART_TOKEN_MAX_AGE,\n  });\n}\n\nexport async function clearCartToken(): Promise<void> {\n  const cookieStore = await cookies();\n  cookieStore.set(getCartCookieName(), '', {\n    maxAge: -1,\n    path: '/',\n  });\n}\n\n// --- Access Token (JWT) ---\n\nexport async function getAccessToken(): Promise<string | undefined> {\n  const cookieStore = await cookies();\n  return cookieStore.get(getAccessTokenCookieName())?.value;\n}\n\nexport async function setAccessToken(token: string): Promise<void> {\n  const cookieStore = await cookies();\n  cookieStore.set(getAccessTokenCookieName(), token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    path: '/',\n    maxAge: ACCESS_TOKEN_MAX_AGE,\n  });\n}\n\nexport async function clearAccessToken(): Promise<void> {\n  const cookieStore = await cookies();\n  cookieStore.set(getAccessTokenCookieName(), '', {\n    maxAge: -1,\n    path: '/',\n  });\n}\n"],"mappings":"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","names":[]}