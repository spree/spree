{"version":3,"sources":["../../src/actions/addresses.ts","../../src/auth-helpers.ts","../../src/config.ts","../../src/cookies.ts"],"sourcesContent":["'use server';\n\nimport { revalidateTag } from 'next/cache';\nimport type { StoreAddress, AddressParams } from '@spree/sdk';\nimport { withAuthRefresh } from '../auth-helpers';\nimport { getClient } from '../config';\n\n/**\n * List the authenticated customer's addresses.\n */\nexport async function listAddresses(): Promise<{ data: StoreAddress[] }> {\n  return withAuthRefresh(async (options) => {\n    return getClient().customer.addresses.list(undefined, options);\n  });\n}\n\n/**\n * Get a single address by ID.\n */\nexport async function getAddress(id: string): Promise<StoreAddress> {\n  return withAuthRefresh(async (options) => {\n    return getClient().customer.addresses.get(id, options);\n  });\n}\n\n/**\n * Create a new address for the customer.\n */\nexport async function createAddress(params: AddressParams): Promise<StoreAddress> {\n  const result = await withAuthRefresh(async (options) => {\n    return getClient().customer.addresses.create(params, options);\n  });\n  revalidateTag('addresses');\n  return result;\n}\n\n/**\n * Update an existing address.\n */\nexport async function updateAddress(\n  id: string,\n  params: Partial<AddressParams>\n): Promise<StoreAddress> {\n  const result = await withAuthRefresh(async (options) => {\n    return getClient().customer.addresses.update(id, params, options);\n  });\n  revalidateTag('addresses');\n  return result;\n}\n\n/**\n * Delete an address.\n */\nexport async function deleteAddress(id: string): Promise<void> {\n  await withAuthRefresh(async (options) => {\n    return getClient().customer.addresses.delete(id, options);\n  });\n  revalidateTag('addresses');\n}\n","import { SpreeError } from '@spree/sdk';\nimport type { RequestOptions } from '@spree/sdk';\nimport { getClient } from './config';\nimport { getAccessToken, setAccessToken, clearAccessToken } from './cookies';\n\n/**\n * Get auth request options from the current JWT token.\n * Proactively refreshes the token if it expires within 1 hour.\n */\nexport async function getAuthOptions(): Promise<RequestOptions> {\n  const token = await getAccessToken();\n  if (!token) {\n    return {};\n  }\n\n  // Check if token is close to expiry by decoding JWT payload\n  try {\n    const payload = JSON.parse(atob(token.split('.')[1]));\n    const exp = payload.exp;\n    const now = Math.floor(Date.now() / 1000);\n\n    // Refresh if token expires in less than 1 hour\n    if (exp && exp - now < 3600) {\n      try {\n        const refreshed = await getClient().auth.refresh({ token });\n        await setAccessToken(refreshed.token);\n        return { token: refreshed.token };\n      } catch {\n        // Refresh failed — use existing token, it might still work\n      }\n    }\n  } catch {\n    // Can't decode JWT — use it as-is, the server will reject if invalid\n  }\n\n  return { token };\n}\n\n/**\n * Execute an authenticated request with automatic token refresh on 401.\n * @param fn - Function that takes RequestOptions and returns a promise\n * @returns The result of the function\n * @throws SpreeError if auth fails after refresh attempt\n */\nexport async function withAuthRefresh<T>(\n  fn: (options: RequestOptions) => Promise<T>\n): Promise<T> {\n  const options = await getAuthOptions();\n\n  if (!options.token) {\n    throw new Error('Not authenticated');\n  }\n\n  try {\n    return await fn(options);\n  } catch (error: unknown) {\n    // If 401, try refreshing the token once\n    if (error instanceof SpreeError && error.status === 401) {\n      try {\n        const refreshed = await getClient().auth.refresh({ token: options.token });\n        await setAccessToken(refreshed.token);\n        return await fn({ token: refreshed.token });\n      } catch {\n        // Refresh failed — clear token and rethrow\n        await clearAccessToken();\n        throw error;\n      }\n    }\n    throw error;\n  }\n}\n","import { createSpreeClient, type SpreeClient } from '@spree/sdk';\nimport type { SpreeNextConfig } from './types';\n\nlet _client: SpreeClient | null = null;\nlet _config: SpreeNextConfig | null = null;\n\n/**\n * Initialize the Spree Next.js integration.\n * Call this once in your app (e.g., in `lib/storefront.ts`).\n * If not called, the client will auto-initialize from SPREE_API_URL and SPREE_API_KEY env vars.\n */\nexport function initSpreeNext(config: SpreeNextConfig): void {\n  _config = config;\n  _client = createSpreeClient({\n    baseUrl: config.baseUrl,\n    apiKey: config.apiKey,\n  });\n}\n\n/**\n * Get the SpreeClient instance. Auto-initializes from env vars if needed.\n * @internal\n */\nexport function getClient(): SpreeClient {\n  if (!_client) {\n    const baseUrl = process.env.SPREE_API_URL;\n    const apiKey = process.env.SPREE_API_KEY;\n    if (baseUrl && apiKey) {\n      initSpreeNext({ baseUrl, apiKey });\n    } else {\n      throw new Error(\n        '@spree/next is not configured. Either call initSpreeNext() or set SPREE_API_URL and SPREE_API_KEY environment variables.'\n      );\n    }\n  }\n  return _client!;\n}\n\n/**\n * Get the current config. Auto-initializes from env vars if needed.\n * @internal\n */\nexport function getConfig(): SpreeNextConfig {\n  if (!_config) {\n    getClient(); // triggers auto-init\n  }\n  return _config!;\n}\n\n/**\n * Reset the client (useful for testing).\n * @internal\n */\nexport function resetClient(): void {\n  _client = null;\n  _config = null;\n}\n","import { cookies } from 'next/headers';\nimport { getConfig } from './config';\n\nconst DEFAULT_CART_COOKIE = '_spree_cart_token';\nconst DEFAULT_ACCESS_TOKEN_COOKIE = '_spree_jwt';\nconst CART_TOKEN_MAX_AGE = 60 * 60 * 24 * 30; // 30 days\nconst ACCESS_TOKEN_MAX_AGE = 60 * 60 * 24 * 7; // 7 days\n\nfunction getCartCookieName(): string {\n  try {\n    return getConfig().cartCookieName ?? DEFAULT_CART_COOKIE;\n  } catch {\n    return DEFAULT_CART_COOKIE;\n  }\n}\n\nfunction getAccessTokenCookieName(): string {\n  try {\n    return getConfig().accessTokenCookieName ?? DEFAULT_ACCESS_TOKEN_COOKIE;\n  } catch {\n    return DEFAULT_ACCESS_TOKEN_COOKIE;\n  }\n}\n\n// --- Cart Token ---\n\nexport async function getCartToken(): Promise<string | undefined> {\n  const cookieStore = await cookies();\n  return cookieStore.get(getCartCookieName())?.value;\n}\n\nexport async function setCartToken(token: string): Promise<void> {\n  const cookieStore = await cookies();\n  cookieStore.set(getCartCookieName(), token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    path: '/',\n    maxAge: CART_TOKEN_MAX_AGE,\n  });\n}\n\nexport async function clearCartToken(): Promise<void> {\n  const cookieStore = await cookies();\n  cookieStore.set(getCartCookieName(), '', {\n    maxAge: -1,\n    path: '/',\n  });\n}\n\n// --- Access Token (JWT) ---\n\nexport async function getAccessToken(): Promise<string | undefined> {\n  const cookieStore = await cookies();\n  return cookieStore.get(getAccessTokenCookieName())?.value;\n}\n\nexport async function setAccessToken(token: string): Promise<void> {\n  const cookieStore = await cookies();\n  cookieStore.set(getAccessTokenCookieName(), token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    path: '/',\n    maxAge: ACCESS_TOKEN_MAX_AGE,\n  });\n}\n\nexport async function clearAccessToken(): Promise<void> {\n  const cookieStore = await cookies();\n  cookieStore.set(getAccessTokenCookieName(), '', {\n    maxAge: -1,\n    path: '/',\n  });\n}\n"],"mappings":"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","names":[]}