version: 2.1

# Reusable image references
images:
  ruby: &ruby_image cimg/ruby:3.4
  ruby_browsers: &ruby_browsers_image cimg/ruby:3.4-browsers

defaults: &defaults
  environment: &environment
    CIRCLE_TEST_REPORTS: /tmp/test-results
    CIRCLE_ARTIFACTS: /tmp/test-artifacts
    BUNDLE_JOBS: 4
    BUNDLE_RETRY: 3
    BUNDLE_PATH: ~/spree/vendor/bundle
    DB_HOST: localhost
    DB: postgres
    DB_USERNAME: postgres
    # Disable Rails verbose query logs in test for performance
    RAILS_LOG_LEVEL: warn
  working_directory: ~/spree
  docker:
    - image: *ruby_image

# Environment for Rails 7.2 (MySQL tests)
mysql_environment: &mysql_environment
  <<: *environment
  DB: mysql
  DB_USERNAME: root
  DB_PASSWORD: password
  DB_HOST: 127.0.0.1
  RAILS_VERSION: 7.2.0

commands:
  install_libvips:
    steps:
      - run:
          name: Install libvips
          command: |
            sudo apt-get update && sudo apt-get install -y libvips-dev
  store_all_artifacts:
    steps:
      - store_artifacts:
          path: /tmp/test-artifacts
          destination: test-artifacts
      - store_artifacts:
          path: /tmp/failed_tests
          destination: failed_tests
      - store_artifacts:
          path: /tmp/test-results
          destination: raw-test-output
      - store_test_results:
          path: /tmp/test-results

jobs:
  # Build job for Rails 8 (default, used by PostgreSQL tests)
  build_rails_8:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - spree-bundle-v13-rails8-{{ checksum "Gemfile" }}
            - spree-bundle-v13-rails8
      - install_libvips
      - run:
          name: Install dependencies
          command: |
            bundle check || bundle install
            bundle clean
            bin/build-ci.rb install
      - save_cache:
          key: spree-bundle-v13-rails8-{{ checksum "Gemfile" }}
          paths:
            - ~/spree/vendor/bundle
      - persist_to_workspace:
          root: ~/spree
          paths:
            - vendor/bundle

  # Build job for Rails 7.2 (used by MySQL tests)
  build_rails_72:
    <<: *defaults
    environment:
      <<: *mysql_environment
    steps:
      - checkout
      - restore_cache:
          keys:
            - spree-bundle-v13-rails72-{{ checksum "Gemfile" }}
            - spree-bundle-v13-rails72
      - install_libvips
      - run:
          name: Install dependencies for Rails 7.2
          command: |
            bundle check || bundle install
            bundle clean
            bin/build-ci.rb install
      - save_cache:
          key: spree-bundle-v13-rails72-{{ checksum "Gemfile" }}
          paths:
            - ~/spree/vendor/bundle
      - persist_to_workspace:
          root: ~/spree
          paths:
            - vendor/bundle

  # Reusable database image configs
  postgres_image: &postgres_image
    image: cimg/postgres:16.2
    environment:
      POSTGRES_USER: postgres
      POSTGRES_HOST_AUTH_METHOD: trust
    command: >
      -c fsync=off
      -c synchronous_commit=off
      -c full_page_writes=off
      -c random_page_cost=1.0
      -c shared_buffers=256MB
      -c work_mem=64MB
      -c maintenance_work_mem=128MB
      -c effective_cache_size=512MB
      -c max_connections=200

  mysql_image: &mysql_image
    image: cimg/mysql:8.0
    command: >
      --default-authentication-plugin=mysql_native_password
      --innodb-flush-log-at-trx-commit=0
      --innodb-flush-method=nosync
      --innodb-doublewrite=0
      --sync-binlog=0
      --innodb-buffer-pool-size=256M
    environment:
      MYSQL_ROOT_PASSWORD: password

  # Reusable test steps
  test_steps: &test_steps
    - checkout
    - attach_workspace:
        at: ~/spree
    - install_libvips
    - run:
        name: Configure bundle path
        command: bundle config set --local path ~/spree/vendor/bundle
    - run:
        name: Run tests
        command: bin/build-ci.rb test
    - store_all_artifacts

  # PostgreSQL test job templates
  test_postgres: &test_postgres
    <<: *defaults
    docker:
      - image: *ruby_image
      - *postgres_image
    steps: *test_steps

  test_postgres_browsers: &test_postgres_browsers
    <<: *defaults
    docker:
      - image: *ruby_browsers_image
      - *postgres_image
    steps: *test_steps

  # MySQL test job templates
  test_mysql: &test_mysql
    <<: *defaults
    docker:
      - image: *ruby_image
      - *mysql_image
    environment:
      <<: *mysql_environment
    steps: *test_steps

  test_mysql_browsers: &test_mysql_browsers
    <<: *defaults
    docker:
      - image: *ruby_browsers_image
      - *mysql_image
    environment:
      <<: *mysql_environment
    steps: *test_steps

  # PostgreSQL test jobs
  test_core_postgres:
    <<: *test_postgres
    parallelism: 6
    environment:
      <<: *environment
      PROJECTS: core
  test_api_postgres:
    <<: *test_postgres
    parallelism: 4
    environment:
      <<: *environment
      PROJECTS: api
  test_admin_postgres:
    <<: *test_postgres_browsers
    parallelism: 2
    environment:
      <<: *environment
      PROJECTS: admin
  test_storefront_postgres:
    <<: *test_postgres_browsers
    parallelism: 2
    environment:
      <<: *environment
      PROJECTS: storefront
  test_page_builder_postgres:
    <<: *test_postgres_browsers
    parallelism: 1
    environment:
      <<: *environment
      PROJECTS: page_builder
  test_other_postgres:
    <<: *test_postgres
    environment:
      <<: *environment
      PROJECTS: emails,sample

  # MySQL test jobs
  test_core_mysql:
    <<: *test_mysql
    parallelism: 6
    environment:
      <<: *mysql_environment
      PROJECTS: core
  test_api_mysql:
    <<: *test_mysql
    parallelism: 4
    environment:
      <<: *mysql_environment
      PROJECTS: api
  test_admin_mysql:
    <<: *test_mysql_browsers
    parallelism: 2
    environment:
      <<: *mysql_environment
      PROJECTS: admin
  test_storefront_mysql:
    <<: *test_mysql_browsers
    parallelism: 2
    environment:
      <<: *mysql_environment
      PROJECTS: storefront
  test_page_builder_mysql:
    <<: *test_mysql_browsers
    parallelism: 1
    environment:
      <<: *mysql_environment
      PROJECTS: page_builder
  test_other_mysql:
    <<: *test_mysql
    environment:
      <<: *mysql_environment
      PROJECTS: emails,sample

  # Brakeman security scan
  brakeman:
    <<: *defaults
    steps:
      - checkout
      - attach_workspace:
          at: ~/spree
      - install_libvips
      - run:
          name: Configure bundle path
          command: bundle config set --local path ~/spree/vendor/bundle
      - run: bin/brakeman.sh
      - run:
          name: Move brakeman reports to artifacts directory
          command: |
            mkdir -p /tmp/test-artifacts/
            mv brakeman-*.* /tmp/test-artifacts/
      - store_artifacts:
          path: /tmp/test-artifacts
          destination: brakeman-reports

workflows:
  main:
    jobs:
      # Build jobs run in parallel
      - build_rails_8
      - build_rails_72

      # PostgreSQL tests depend on Rails 8 build
      - test_core_postgres:
          requires:
            - build_rails_8
      - test_api_postgres:
          requires:
            - build_rails_8
      - test_admin_postgres:
          requires:
            - build_rails_8
      - test_storefront_postgres:
          requires:
            - build_rails_8
      - test_page_builder_postgres:
          requires:
            - build_rails_8
      - test_other_postgres:
          requires:
            - build_rails_8

      # MySQL tests depend on Rails 7.2 build
      - test_core_mysql:
          requires:
            - build_rails_72
      - test_api_mysql:
          requires:
            - build_rails_72
      - test_admin_mysql:
          requires:
            - build_rails_72
      - test_storefront_mysql:
          requires:
            - build_rails_72
      - test_page_builder_mysql:
          requires:
            - build_rails_72
      - test_other_mysql:
          requires:
            - build_rails_72

      # Brakeman depends on Rails 8 build
      - brakeman:
          requires:
            - build_rails_8
